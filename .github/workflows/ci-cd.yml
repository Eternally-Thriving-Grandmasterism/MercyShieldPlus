name: MercyShieldPlus CI/CD Eternal ⚡️

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]  # Trigger CD on GitHub Release

jobs:
  rust-lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Rust Format & Clippy
        run: |
          cd rust
          cargo fmt -- --check
          cargo clippy -- -D warnings

      - name: Rust Tests
        run: |
          cd rust
          cargo test --release

      - name: Rust Multi-Arch Build (NDK)
        run: |
          cd rust
          cargo ndk -t armeabi-v7a -t arm64-v8a -t x86 -t x86_64 build --release

  android-build-test:
    needs: rust-lint-test
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build Rust Core (Copy .so)
        run: |
          ./gradlew buildRustRelease  # Uses task from build.gradle.kts

      - name: Android Lint & Unit Tests
        run: ./gradlew lint testDebugUnitTest

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mercyshieldplus-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

  release:
    needs: android-build-test
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating release assets
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: mercyshieldplus-apk

      - name: Create GitHub Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} *.apk --clobber
